# Описание системы учета подарков для Деда Мороза

### Развертывание и запуск системы

Сборка программы выполняется в файл presents-system-0.0.1-SNAPSHOT.jar, который содержит базу данных и сервер.
Встроенный сервер использует адрес http://localhost:8091/

Перед запуском программы необходимо запустить вспомогательный сервер производства подарков manufacturing-0.0.1-SNAPSHOT.jar, который использует адрес http://localhost:8092/
Иначе система после запуска выдаст сообщение о недоступности сервера производства подарков и завершится.
 
### Встроенная база данных H2

Таблицы бд описаны в файле data.sql

Storage - таблица для хранения подарков на складе
Ordered - таблица для записи предзаказа на подарок, а также для учета подарков, отправленных со склада в хранилище
Manufacturing - таблица для хранения записи о подарках, которые отправлены на производство

Таблицы содержат необходимые проверки:
1. Кол-во подарков на складе и значение допустимого количества подарков не пожет быть < 0
2. Хранилище с подарками может содержать несколько заказов от одного ребенка, но за разные года
3. Запросами на производство подарков должен содержать количество > 0

### InformationSystemRestService - основной rest - контроллер для взаимодействия с пользователем

#### newOrder - метод получения одного заказа

пример запроса:
{"productType" :"bicycle", "fio":"Иванов Иван Иванович", "year":"2020"}

Описание алгоритма обработки:
1. Выполняется проверка нет ли уже принятого заказа на подарок для данного ребенка в указанном году в таблице Ordered.
2. Запрашивается поведение ребенка
3. Создается предзаказ в таблице Ordered с флагом released = false.
4. Выполняется проверка формата запроса
5. Выполняется проверка наличия подарка на складе. Если подарок есть, то он отправляется со склада в хранилище - в таблице Ordered флаг released принимает значение true.
После отправки подарка в хранилище проверяется не стало ли количество подарков данного типа меньше допустимого минимального значения.

Если данного подарка на складе не было, то система отправляет запрос на производство подарка на фабрику.

Если в запросе был указан подарок нового типа, то система автоматически создает запись на складе и отправляет запрос на производство подарка на фабрику.

#### newOrders - метод получения списка заказов
Обрабатывается аналогично методу newOrder

пример запроса:
{
    "orders":[
    
        {"productType" :"bicycle", "fio":"Иванов Иван Иванович", "year":"2020" },
        
        {"productType":"bicycle", "fio":"Петров Петя Петрович"}
    ]
}


#### refreshProducts - метод изменения минимально - допустимого количества подарков на складе
пример запроса:
{
    "storages":[
    
        {"productType":"roller skates", "minValue":"100"},
        
        {"productType":"bicycle", "minValue":"50"},
        
        {"productType":"book", "minValue":"2"}
    ]
}

#### getProducts - получение списка всех подарков и заказов

#### getOrdersByProductType - получение списка всех заказанных подарков указанного типа

### отправка запроса на производство подарков и получение произведенных подарков

Система проверяет наличие необходимого количества подарков на складе в следующих случаях:
1. При запуске системы
2. При каждом переводе подарка со склада в хранилище
3. При получении запроса от ребенка

Проверка выполняется в контроллере InformationSystemDBService в методе checkMinAvailableProducts.
Также система проверяет нет ли уже отправленного запроса на производства. И если есть, то выполняется ли условие:
availableValue + manufacturingNow < minValue

Непосредственно отправка запроса на сервер производства подарков выполняется в методе sendManufacturingRequest.
Запрос на производство включает в себя идентификатор данного запроса, тип подарка и необходимое количество.

Фабрика производит подарки с рандомной задержкой от 200 мс до 2200 мс.
 
ProductionRestService - rest - контроллер для получения произведенных подарков с фабрики.

Содержит 1 метод - sendPresentToOrder, который принимает json - представления класса Manufacturing и отправляет ответ 
от фабрики на обработку. Manufacturing содержит номер запроса на производство, тип подарка и количество.

При получении изготовленных подарков с фабрики выполняются действия:
1. Удаление соответствующего запроса на производство в таблице Manufacturing
2. Запись количества изготовленных подарков в таблицу Storage
3. Перевод подарков из таблицы Storage в Ordered, если в таблице Ordered есть не исполненные заказы
4. Уменьшение количества подарков в Storage
5. Проверка минимального значения имеющихся заказов в таблице Storage


#### Заглушка для сервиса поведения ребенка реализована в сервисе DemeanourServiceImpl

#### Методы по работе с БД реализованы в сервисе InformationSystemDBService 

#### Тесты реализованы в классе PresentsSystemApplicationTests

Примечания:
1. Не все методы на данный момент покрыты тестами
2. Перед запуском приложение необходимо запустить приложение-фабрику manufacturing-0.0.1-SNAPSHOT.jar
3. Для проверки работы системы удобно использовать Postman